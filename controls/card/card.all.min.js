"use strict";angular.module("formarble/controls/card",["formarble"]).directive("fmCard",["fm",function(e){function r(e,r,t){var n,o=[];for(r+=t?1:0,n=e;r>n;n++)o.push(n);return o}function t(r,t,n){r.$watch(t,function(t){e.oset(r,n,t)}),r.$watch(n,function(n){e.oset(r,t,n)})}var n=new Date;return{templateUrl:e.urlResolver("card"),controllerAs:"card",controller:["$scope","$element",function(e){var o=this,a="year",c="month",l="number",s="name",i="code",d=n.getFullYear(),u=d+10,m=n.getMonth()+1,f=r(m,12,!0),v=r(1,12,!0);this._years=r(d,u,!0),this._months=v,e.$watch(a,function(r){r===d?(o._months=f,e.month<m&&(e.month=m)):o._months=v}),angular.forEach([s,l,a,c,i],function(r){var n=["$model",e.$control.properties[r]._path].join(".");t(e,n,r)})}]}}]).directive("fmCardNumberInput",["$browser",function(e){function r(e,r,t,n,o){for(n=+e[r=e.length-1],o=0;r--;)t=+e[r],n+=++o%2?2*t%10+(t>4):t;return!(n%10)}function t(e){if(e.selectionStart)return e.selectionStart;if(document.selection){e.focus();var r=document.selection.createRange();if(null==r)return 0;var t=e.createTextRange(),n=t.duplicate();return t.moveToBookmark(r.getBookmark()),n.setEndPoint("EndToStart",t),n.text.length}return 0}function n(e,r){if(e.createTextRange){var t=e.createTextRange();t.move("character",r),t.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(r,r)):e.focus()}function o(e){return e?e.replace(/[^\d]+/g,""):e}function a(e){var r;if(!e)return e;switch(e=o(e),r=c(e)){case"visa":case"mastercard":default:e=e.slice(0,16).replace(/(\d{4})/g,"$1 ");break;case"amex":e=e.slice(0,15).replace(/^(\d{4})(\d{6})(\d+)/,"$1 $2 $3").replace(/^(\d{4})(\d+)/,"$1 $2")}return e.trim()}function c(e){return e?"4"===e[0]?"visa":-1!==["34","37"].indexOf(e.slice(0,2))?"amex":-1!==["51","52","53","54","55"].indexOf(e.slice(0,2))?"mastercard":void 0:void 0}return{require:"ngModel",link:function(c,l,s,i){function d(){var e,r,o=l.val(),c=t(l[0]);i.$isEmpty(o)||(r=o.slice(0,c),c-=r.length-a(r).length,e=a(o),e!=o&&(l.val(e),n(l[0],c)))}l.bind("keyup",function(){var r=event.keyCode;91==r||r>15&&19>r||r>=37&&40>=r||e.defer(d)}),l.bind("change paste cut",function(){e.defer(d)}),i.$formatters.push(function(e){return e?a(e):void 0}),i.$parsers.unshift(function(e){return e?o(a(e)):void 0}),i.$parsers.push(function(e){return i.$error.required?void i.$setValidity("creditCard",!0):!i.$isEmpty(e)&&r(e)?(i.$setValidity("creditCard",!0),e):void i.$setValidity("creditCard",!1)})}}}]),angular.module("formarble/controls/card").run(["$templateCache",function(e){e.put("bs-common/card.html",'<div class="form-group"><label class="control-label col-sm-4" for="name">Name</label><div class="col-sm-8"><input id="name" class="form-control" type="text" ng-model="name"></div></div><div class="form-group"><label class="control-label col-sm-4" for="number">Card number</label><div class="col-sm-8"><input id="number" class="form-control" type="text" ng-model="number" fm-card-number-input=""></div></div><div class="form-group"><label class="control-label col-sm-4" for="year">Expiration</label><div class="col-sm-4"><div class="row"><div class="col-xs-6"><select id="year" class="form-control" ng-model="year" ng-options="y for y in card._years"></select></div><div class="col-xs-6"><select id="month" class="form-control" ng-model="month" ng-options="m for m in card._months"></select></div></div></div><label class="control-label col-sm-2" for="code">CVV</label><div class="col-sm-2"><input id="code" class="form-control" type="password" ng-minlength="3" ng-maxlength="4" ng-model="code"></div></div>')}]);