"use strict";angular.module("formarble/controls/card",["formarble"]).directive("fmCard",["fm",function(e){function r(e,r,t){var n,o=[];for(r+=t?1:0,n=e;r>n;n++)o.push(n);return o}var t=new Date;return{templateUrl:e.urlResolver("card"),controllerAs:"card",controller:["$scope","$element",function(e){var n=this,o="year",c="month",a="number",i="name",l="code",s=t.getFullYear(),d=s+10,u=t.getMonth()+1,m=r(u,12,!0),f=r(1,12,!0);this._years=r(s,d,!0),this._months=f,e.$watch(o,function(r){r===s?(n._months=m,e.month<u&&(e.month=u)):n._months=f}),this.name=e.$control.properties.name,this.number=angular.extend({},e.$control.properties.number,{display:{name:"fm-card-number"}}),this.year=e.$control.properties.year,this.month=e.$control.properties.month,this.code=e.$control.properties.code,angular.forEach([i,a,o,c,l],function(){})}]}}]).directive("fmCardNumber",["fm",function(e){return{templateUrl:e.urlResolver("card-number")}}]).directive("fmCardNumberInput",["fm","$browser",function(e,r){function t(r,t,n){r.$watch(t,function(t){e.oset(r,n,t)}),r.$watch(n,function(n){e.oset(r,t,n)})}function n(e,r,t,n,o){for(n=+e[r=e.length-1],o=0;r--;)t=+e[r],n+=++o%2?2*t%10+(t>4):t;return!(n%10)}function o(e){if(e.selectionStart)return e.selectionStart;if(document.selection){e.focus();var r=document.selection.createRange();if(null==r)return 0;var t=e.createTextRange(),n=t.duplicate();return t.moveToBookmark(r.getBookmark()),n.setEndPoint("EndToStart",t),n.text.length}return 0}function c(e,r){if(e.createTextRange){var t=e.createTextRange();t.move("character",r),t.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(r,r)):e.focus()}function a(e){return e?e.replace(/[^\d]+/g,""):e}function i(e){var r;if(!e)return e;switch(e=a(e),r=l(e)){case"visa":case"mastercard":default:e=e.slice(0,16).replace(/(\d{4})/g,"$1 ");break;case"amex":e=e.slice(0,15).replace(/^(\d{4})(\d{6})(\d+)/,"$1 $2 $3").replace(/^(\d{4})(\d+)/,"$1 $2")}return e.trim()}function l(e){return e?"4"===e[0]?"visa":-1!==["34","37"].indexOf(e.slice(0,2))?"amex":-1!==["51","52","53","54","55"].indexOf(e.slice(0,2))?"mastercard":void 0:void 0}function s(e){var r=e.keyCode;return 46==r||8==r||91==r||r>15&&19>r||r>=37&&40>=r}return{require:"ngModel",link:function(e,l,d,u){function m(){var e,r,t=l.val(),n=o(l[0]);u.$isEmpty(t)||(r=t.slice(0,n),n-=r.length-i(r).length,e=i(t),e!=t&&(l.val(e),c(l[0],n)))}l.attr("id",e.$control.$id),l.bind("keyup",function(e){s(e)||r.defer(m)}),l.bind("change paste cut",function(){r.defer(m)}),u.$formatters.push(function(e){return e?i(e):void 0}),u.$parsers.unshift(function(e){return e?a(i(e)):void 0}),u.$parsers.push(function(e){return u.$error.required?void u.$setValidity("creditCard",!0):!u.$isEmpty(e)&&n(e)?(u.$setValidity("creditCard",!0),e):void u.$setValidity("creditCard",!1)}),e.$input=u,t(e,"number",["$model",e.$control._path].join("."))}}}]),angular.module("formarble/controls/card").run(["$templateCache",function(e){e.put("bs-common/card-number.html",'<div class="form-group" ng-class="{\'has-error\': $input.$dirty && $input.$invalid}"><label class="control-label col-sm-4" fm-control-label="">{{card.numberTitle}}</label><div class="col-sm-8"><input class="form-control" type="text" ng-model="number" fm-card-number-input="" required=""></div></div>')}]),angular.module("formarble/controls/card").run(["$templateCache",function(e){e.put("bs-common/card.html",'<div ng-form="cf"><div fm-control="card.name"></div><div fm-control="card.number"></div><div class="form-group"><label class="control-label col-sm-4">Expiration</label><div class="col-sm-4"><div class="row"><div class="col-xs-6" fm-control="card.year"></div><div class="col-xs-6" fm-control="card.month"></div></div></div><div class="col-sm-4" fm-control="card.code"></div></div></div>')}]);