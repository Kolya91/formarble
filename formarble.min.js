"use strict";angular.module("formarble",[]).service("fm",function(){var e=/^\d+$/,t={oget:function(e,t){var n,r=t.split("."),o=e,i=r.length;for(n=0;i>n;n++)if(o=o[r[n]],void 0===o)return;return o},oset:function(t,n,r){var o,i,l=n.split("."),u=t;for(i=0;i<l.length-1;++i)o=l[i],void 0===u[o]&&(u[o]=e.test(l[i+1])?[]:{}),u=u[o];return u[l[i]]=r},odel:function(e,n){var r=n.split("."),o=r.pop(),i=r.join("."),l=t.oget(e,i);return l.splice?l.splice(o,1):delete l[o],e},walkProps:function(e,n){angular.forEach(e.properties,function(e){n(e),t.walkProps(e,n)})},isEmpty:function(e){return void 0===e||null===e||angular.equals(e,{})||angular.equals(e,[])},urlResolver:function(e){return function(t){return t.controller("fmForm").getTemplateUrl(e)}}};return t}).directive("fmForm",["$compile",function(e){return{restrict:"EA",require:"fmForm",scope:{$control:"=fmForm",$model:"=ngModel"},terminal:!0,controllerAs:"$form",controller:["$scope","$attrs",function(e,t){this.getTemplateUrl=function(e){return(t.fmTheme||"default")+"/"+e+".html"},this.getControlModel=function(e){return["$model",e._path].join(".")},this.getControlId=function(e){return e._path&&e._path.split(".").join("-")},this.getProperties=function(e){return angular.isObject(e.properties)?Object.keys(e.properties).map(function(t){return e.properties[t]}).sort(function(e,t){return angular.isDefined(e.order)&&angular.isDefined(t.order)?e.order-t.order:angular.isDefined(e.order)?-1:angular.isDefined(t.order)?1:e._order-t._order}):void 0}}],link:function(t,n){n.find("[fm-control]").length||n.append("<div fm-control></div>"),e(n.contents())(t)}}}]).directive("fmControl",["$compile","$injector","fm",function(e,t,n){var r="Directive";return{require:"^fmForm",terminal:!0,link:function(o,i,l,u){var a,f,c=l.fmControl||"$control";o.$watch(c,function(c){if(a&&a.$destroy(),f&&l.$set(f,null),i.html(""),c){if(!c.display)return void console.warn("fmControl","Display options not defined",c);var s,d=l.$normalize(c.display.name);if(!t.has(d+r))return void console.warn("fmControl","No directive",d,"defined",c);a=s=o.$new(),f=d,l.$set("fmControl",null),l.$set("ngRepeat",null),l.$set(d,""),c.$id=u.getControlId(c),c.$model=u.getControlModel(c),s.$control=c,s.$subControls=u.getProperties(c),angular.isDefined(c.properties)||(s.$useDefault=!angular.isDefined(n.oget(o.$model,c._path)),s.$setRecommended=function(){var e=angular.isDefined(c.recommend)?c.recommend:null;n.oset(o.$model,c._path,e),s.$useDefault=!1},s.$setEmpty=function(){n.odel(o.$model,c._path),s.$useDefault=!0},o.$watch(c.$model,function(e){c.$value=s.$value=e,c.$empty=s.$empty=void 0===e||null===e})),i.data("$control",c),e(i)(s)}})}}}]).directive("fmControlLabel",["fm",function(e){return{templateUrl:e.urlResolver("control-label"),link:function(e,t,n){var r=e.$eval(n.fmControlLabel||"$control");void 0===n.for&&n.$set("for",r.$id)}}}]).directive("fmControlEmpty",["fm",function(e){return{priority:600,templateUrl:e.urlResolver("control-empty")}}]).directive("fmControlInput",["$compile","fm",function(e){function t(e){return"ng"+e.charAt(0).toUpperCase()+e.slice(1)}var n=["pattern","minlength","maxlength","required"],r=["min","max","step"];return{require:"^fmForm",priority:200,terminal:!0,compile:function(o,i){var l=o.prop("tagName"),u="SELECT"===l,a="INPUT"===l||"TEXTAREA"===l,f=i.fmControlInput||"$control";return i.$set("fmControlInput",null),function(o,i,l){var c=o.$eval(f);l.$set("ngModel",c.$model),l.$set("id",c.$id),a&&(l.type||l.$set("type",c.display.type),n.forEach(function(e){var n=c.display[e];angular.isDefined(n)&&l.$set(t(e),n)}),r.forEach(function(e){var t=c.display[e];angular.isDefined(t)&&l.$set(e,t)})),u&&l.$set("ngOptions","o.id as o.title for o in "+f+".display.options"),e(i)(o),o.$input=i.controller("ngModel")}}}}]).directive("fmReset",function(){return{require:"^form",link:function(e,t,n,r){function o(t){n.ngClick||t.preventDefault(),e.$apply(e.$control.$model+" = undefined"),r.$setPristine()}t.bind("click",o),e.$on("destroy",function(){t.unbind("click",o)})}}});